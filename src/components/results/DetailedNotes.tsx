import { useState, useRef } from "react";
import { ChevronDown, ChevronUp, BookOpen, Lightbulb, Download, Printer } from "lucide-react";
import { cn } from "@/lib/utils";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";

interface DetailedNote {
  heading: string;
  content: string;
  keyPoints?: string[];
}

interface DetailedNotesProps {
  notes: DetailedNote[];
}

export const DetailedNotes = ({ notes }: DetailedNotesProps) => {
  const [expandedIndex, setExpandedIndex] = useState<number | null>(0);
  const printRef = useRef<HTMLDivElement>(null);

  const toggleExpand = (index: number) => {
    setExpandedIndex(expandedIndex === index ? null : index);
  };

  const handleExportPDF = () => {
    // Create a new window with print-friendly content
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      toast.error("Please allow popups to export PDF");
      return;
    }

    const htmlContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Study Notes - Detailed Explanations</title>
        <style>
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          body {
            font-family: 'Georgia', serif;
            line-height: 1.8;
            color: #1a1a1a;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
          }
          .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e5e5;
          }
          .header h1 {
            font-size: 28px;
            color: #2563eb;
            margin-bottom: 8px;
          }
          .header p {
            color: #666;
            font-size: 14px;
          }
          .note-section {
            margin-bottom: 32px;
            page-break-inside: avoid;
          }
          .note-heading {
            font-size: 20px;
            color: #1e40af;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dbeafe;
            display: flex;
            align-items: center;
            gap: 12px;
          }
          .note-number {
            background: #2563eb;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
          }
          .note-content {
            text-align: justify;
            margin-bottom: 16px;
            color: #333;
          }
          .key-points {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
          }
          .key-points-title {
            font-weight: bold;
            color: #15803d;
            margin-bottom: 8px;
            font-size: 14px;
          }
          .key-points ul {
            list-style: none;
            padding-left: 0;
          }
          .key-points li {
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
            font-size: 14px;
          }
          .key-points li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #22c55e;
            font-weight: bold;
          }
          .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e5e5e5;
            text-align: center;
            color: #888;
            font-size: 12px;
          }
          @media print {
            body { padding: 20px; }
            .note-section { page-break-inside: avoid; }
          }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>ðŸ“š Study Notes</h1>
          <p>Detailed Explanations - Generated on ${new Date().toLocaleDateString()}</p>
        </div>
        ${notes.map((note, index) => `
          <div class="note-section">
            <h2 class="note-heading">
              <span class="note-number">${index + 1}</span>
              ${note.heading}
            </h2>
            <p class="note-content">${note.content}</p>
            ${note.keyPoints && note.keyPoints.length > 0 ? `
              <div class="key-points">
                <div class="key-points-title">ðŸ’¡ Key Takeaways</div>
                <ul>
                  ${note.keyPoints.map(point => `<li>${point}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
          </div>
        `).join('')}
        <div class="footer">
          <p>Generated by StudyBuddy AI</p>
        </div>
      </body>
      </html>
    `;

    printWindow.document.write(htmlContent);
    printWindow.document.close();
    
    // Wait for content to load then trigger print
    printWindow.onload = () => {
      printWindow.print();
    };

    toast.success("Print dialog opened - Save as PDF!");
  };

  if (!notes || notes.length === 0) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        No detailed notes available
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <BookOpen className="w-5 h-5 text-primary" />
          <h3 className="font-display text-lg font-semibold text-foreground">
            Detailed Explanations
          </h3>
        </div>
        <Button
          variant="outline"
          size="sm"
          onClick={handleExportPDF}
          className="gap-2"
        >
          <Download className="w-4 h-4" />
          <span className="hidden sm:inline">Export PDF</span>
        </Button>
      </div>
      
      <div className="space-y-3" ref={printRef}>
        {notes.map((note, index) => (
          <div
            key={index}
            className={cn(
              "rounded-xl border border-border/50 overflow-hidden transition-all duration-300",
              expandedIndex === index ? "bg-card shadow-soft" : "bg-muted/30 hover:bg-muted/50"
            )}
          >
            {/* Heading - Clickable */}
            <button
              onClick={() => toggleExpand(index)}
              className="w-full flex items-center justify-between p-4 text-left"
            >
              <div className="flex items-center gap-3">
                <span className="flex items-center justify-center w-8 h-8 rounded-lg bg-primary/10 text-primary font-semibold text-sm">
                  {index + 1}
                </span>
                <h4 className="font-display font-semibold text-foreground">
                  {note.heading}
                </h4>
              </div>
              {expandedIndex === index ? (
                <ChevronUp className="w-5 h-5 text-muted-foreground" />
              ) : (
                <ChevronDown className="w-5 h-5 text-muted-foreground" />
              )}
            </button>

            {/* Content - Expanded */}
            {expandedIndex === index && (
              <div className="px-4 pb-4 animate-slide-up">
                <div className="pl-11 space-y-4">
                  {/* Main Content Paragraph */}
                  <p className="text-foreground/90 leading-relaxed whitespace-pre-wrap">
                    {note.content}
                  </p>

                  {/* Key Points */}
                  {note.keyPoints && note.keyPoints.length > 0 && (
                    <div className="mt-4 p-3 rounded-lg bg-accent/10 border border-accent/20">
                      <div className="flex items-center gap-2 mb-2">
                        <Lightbulb className="w-4 h-4 text-accent" />
                        <span className="text-sm font-medium text-accent">Key Takeaways</span>
                      </div>
                      <ul className="space-y-1.5">
                        {note.keyPoints.map((point, pIndex) => (
                          <li key={pIndex} className="flex items-start gap-2 text-sm text-foreground/80">
                            <span className="text-accent mt-1">â€¢</span>
                            <span>{point}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        ))}
      </div>

      {/* Expand/Collapse All */}
      <div className="flex justify-center pt-2">
        <button
          onClick={() => setExpandedIndex(expandedIndex === null ? 0 : null)}
          className="text-sm text-muted-foreground hover:text-foreground transition-colors"
        >
          {expandedIndex !== null ? "Collapse All" : "Expand First"}
        </button>
      </div>
    </div>
  );
};
